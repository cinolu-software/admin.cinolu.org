<div class="space-y-8">
  @let isLoadingGeneral = store.isLoadingGeneral();
  @let generalData = store.general();
  @let isLoadingByYear = store.isLoadingByYear();
  @let byYearData = store.byYear();
  <div aria-labelledby="stats-general-heading">
    <h2 id="stats-general-heading" class="sr-only">Statistiques générales</h2>
    @if (isLoadingGeneral && !generalData) {
      <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
        @for (i of [1, 2, 3, 4]; track i) {
          <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm animate-pulse">
            <div class="h-10 w-10 rounded-xl bg-gray-200 mb-4"></div>
            <div class="h-8 w-16 bg-gray-200 rounded mb-2"></div>
            <div class="h-4 w-24 bg-gray-100 rounded"></div>
          </div>
        }
      </div>
    }
    @if (generalData; as g) {
      <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
        <div
          class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm hover:shadow-md transition-shadow duration-200">
          <div
            class="inline-flex size-12 items-center justify-center rounded-xl bg-primary-100 text-primary-600 mb-4"
            aria-hidden="true">
            <i-lucide [name]="icons.Users" class="size-6" />
          </div>
          <p class="text-2xl font-bold text-gray-900 tabular-nums">{{ g.totalUsers }}</p>
          <p class="text-sm font-medium text-gray-500 mt-0.5">Utilisateurs</p>
        </div>
        <div
          class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm hover:shadow-md transition-shadow duration-200">
          <div
            class="inline-flex size-12 items-center justify-center rounded-xl bg-primary-100 text-primary-600 mb-4"
            aria-hidden="true">
            <i-lucide [name]="icons.FolderKanban" class="size-6" />
          </div>
          <p class="text-2xl font-bold text-gray-900 tabular-nums">{{ g.totalProjects }}</p>
          <p class="text-sm font-medium text-gray-500 mt-0.5">Projets</p>
        </div>
        <div
          class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm hover:shadow-md transition-shadow duration-200">
          <div
            class="inline-flex size-12 items-center justify-center rounded-xl bg-primary-100 text-primary-600 mb-4"
            aria-hidden="true">
            <i-lucide [name]="icons.CalendarDays" class="size-6" />
          </div>
          <p class="text-2xl font-bold text-gray-900 tabular-nums">{{ g.totalEvents }}</p>
          <p class="text-sm font-medium text-gray-500 mt-0.5">Événements</p>
        </div>
        <div
          class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm hover:shadow-md transition-shadow duration-200">
          <div
            class="inline-flex size-12 items-center justify-center rounded-xl bg-primary-100 text-primary-600 mb-4"
            aria-hidden="true">
            <i-lucide [name]="icons.Rocket" class="size-6" />
          </div>
          <p class="text-2xl font-bold text-gray-900 tabular-nums">{{ g.totalVentures }}</p>
          <p class="text-sm font-medium text-gray-500 mt-0.5">Startups</p>
        </div>
      </div>
    }
  </div>

  <div class="space-y-6">
    <div
      class="flex flex-col md:flex-row md:items-center justify-between gap-4 border bg-white/90 border-gray-200 px-8 py-6 rounded-lg">
      <h2 class="text-lg font-bold text-gray-900">Participations par année</h2>
      <app-ui-select
        id="stats-year-select"
        class="w-full md:w-32"
        [options]="yearSelectOptions()"
        [(ngModel)]="selectedYear" />
    </div>
    @if (isLoadingByYear && !byYearData) {
      <div class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm animate-pulse">
        <div class="h-24 bg-gray-100 rounded-xl mb-6"></div>
        <div class="h-64 bg-gray-100 rounded-xl"></div>
      </div>
    }
    @if (byYearData; as data) {
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="rounded-lg border border-gray-200 bg-white p-5 shadow-sm">
          <div class="flex items-center gap-3">
            <div class="inline-flex size-10 items-center justify-center rounded-lg bg-primary-100 text-primary-600">
              <i-lucide [name]="icons.ChartBar" class="size-5" />
            </div>
            <div>
              <p class="text-xl font-bold text-gray-900 tabular-nums">{{ data.summary.totalParticipations }}</p>
              <p class="text-xs font-medium text-gray-500">Total participations</p>
            </div>
          </div>
        </div>
        <div class="rounded-lg border border-gray-200 bg-white p-5 shadow-sm">
          <div class="flex items-center gap-3">
            <div class="inline-flex size-10 items-center justify-center rounded-lg bg-primary-100 text-primary-600">
              <i-lucide [name]="icons.FolderKanban" class="size-5" />
            </div>
            <div>
              <p class="text-xl font-bold text-gray-900 tabular-nums">{{ data.summary.totalProjectParticipations }}</p>
              <p class="text-xs font-medium text-gray-500">Participants aux projets</p>
            </div>
          </div>
        </div>
        <div class="rounded-lg border border-gray-200 bg-white p-5 shadow-sm">
          <div class="flex items-center gap-3">
            <div class="inline-flex size-10 items-center justify-center rounded-lg bg-primary-100 text-primary-600">
              <i-lucide [name]="icons.CalendarDays" class="size-5" />
            </div>
            <div>
              <p class="text-xl font-bold text-gray-900 tabular-nums">{{ data.summary.totalEventParticipations }}</p>
              <p class="text-xs font-medium text-gray-500">Participants aux événements</p>
            </div>
          </div>
        </div>
      </div>

      @if (data.detailedParticipations.programs.length > 0) {
        <div class="rounded-lg border border-gray-200 bg-white shadow-sm overflow-hidden">
          <div class="px-6 py-4 border-b border-gray-100">
            <h3 class="text-base font-semibold text-gray-900 flex items-center gap-2">
              <i-lucide [name]="icons.LayoutList" class="size-4 text-gray-500" />
              Détail par programme
            </h3>
          </div>
          <div class="p-4">
            <div class="space-y-2">
              @for (program of data.detailedParticipations.programs; track program.id) {
                <div class="rounded-lg border border-gray-100 bg-gray-50/50 overflow-hidden">
                  <button
                    type="button"
                    class="w-full px-4 py-3 flex items-center gap-3 hover:bg-gray-100/50 transition-colors"
                    (click)="toggleProgram(program.id)">
                    <i-lucide
                      [name]="isProgramExpanded(program.id) ? icons.ChevronDown : icons.ChevronRight"
                      class="size-4 text-gray-400 shrink-0" />
                    <i-lucide
                      [name]="isProgramExpanded(program.id) ? icons.FolderOpen : icons.Folder"
                      class="size-5 text-primary-600 shrink-0" />
                    <span class="font-semibold text-gray-900 flex-1 text-left">{{ program.name }}</span>
                    <span
                      class="px-2.5 py-1 bg-primary-100 text-primary-700 text-sm font-semibold rounded-full tabular-nums">
                      {{ program.participations }}
                    </span>
                  </button>
                  @if (isProgramExpanded(program.id) && program.subprograms.length > 0) {
                    <div class="bg-white border-t border-gray-100">
                      @for (subprogram of program.subprograms; track subprogram.id) {
                        <div class="border-b border-gray-50 last:border-b-0">
                          <button
                            type="button"
                            class="w-full px-4 py-2.5 pl-12 flex items-center gap-3 hover:bg-gray-50 transition-colors"
                            (click)="toggleSubprogram(subprogram.id)">
                            <i-lucide
                              [name]="isSubprogramExpanded(subprogram.id) ? icons.ChevronDown : icons.ChevronRight"
                              class="size-3.5 text-gray-400 shrink-0" />
                            <i-lucide [name]="icons.FolderKanban" class="size-4 text-blue-600 shrink-0" />
                            <span class="font-medium text-gray-800 flex-1 text-left text-sm">{{
                              subprogram.name
                            }}</span>
                            <span
                              class="px-2 py-0.5 bg-blue-50 text-blue-700 text-xs font-semibold rounded-full tabular-nums">
                              {{ subprogram.participations }}
                            </span>
                          </button>
                          @if (isSubprogramExpanded(subprogram.id)) {
                            <div class="px-4 py-3 pl-16 bg-gray-50/50 space-y-3">
                              @if (subprogram.projects.length > 0) {
                                <div>
                                  <div class="flex items-center gap-2 mb-2">
                                    <i-lucide [name]="icons.FileCode" class="size-3.5 text-emerald-600" />
                                    <span class="text-xs font-semibold text-gray-600 uppercase tracking-wide"
                                      >Projets</span
                                    >
                                  </div>
                                  <ul class="space-y-1.5">
                                    @for (project of subprogram.projects; track project.id) {
                                      <li class="flex items-center gap-2 text-sm">
                                        <div class="w-1 h-1 rounded-full bg-emerald-400 shrink-0"></div>
                                        <span class="text-gray-700">{{ project.name }}</span>
                                        <span
                                          class="ml-auto px-1.5 py-0.5 bg-emerald-100 text-emerald-700 text-xs font-medium rounded tabular-nums">
                                          {{ project.participations }}
                                        </span>
                                      </li>
                                    }
                                  </ul>
                                </div>
                              }
                              @if (subprogram.events.length > 0) {
                                <div>
                                  <div class="flex items-center gap-2 mb-2">
                                    <i-lucide [name]="icons.Calendar" class="size-3.5 text-purple-600" />
                                    <span class="text-xs font-semibold text-gray-600 uppercase tracking-wide"
                                      >Événements</span
                                    >
                                  </div>
                                  <ul class="space-y-1.5">
                                    @for (event of subprogram.events; track event.id) {
                                      <li class="flex items-center gap-2 text-sm">
                                        <div class="w-1 h-1 rounded-full bg-purple-400 shrink-0"></div>
                                        <span class="text-gray-700">{{ event.name }}</span>
                                        <span
                                          class="ml-auto px-1.5 py-0.5 bg-purple-100 text-purple-700 text-xs font-medium rounded tabular-nums">
                                          {{ event.participations }}
                                        </span>
                                      </li>
                                    }
                                  </ul>
                                </div>
                              }

                              @if (subprogram.projects.length === 0 && subprogram.events.length === 0) {
                                <p class="text-xs text-gray-400 italic">Aucun projet ou événement</p>
                              }
                            </div>
                          }
                        </div>
                      }
                    </div>
                  }
                  @if (isProgramExpanded(program.id) && program.subprograms.length === 0) {
                    <div class="px-4 py-3 pl-12 bg-white border-t border-gray-100 text-sm text-gray-400 italic">
                      Aucun sous-programme
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        </div>
      } @else {
        <div class="rounded-lg border border-gray-200 bg-white p-12 text-center text-gray-500">
          <i-lucide [name]="icons.LayoutList" class="size-12 mx-auto mb-3 text-gray-300" aria-hidden="true" />
          <p class="font-medium">Aucune participation pour l'année {{ data.year }}</p>
        </div>
      }
    }
  </div>
</div>
