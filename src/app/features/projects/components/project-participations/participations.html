<div class="flex flex-col gap-6">
  @let totalFiltered = filteredParticipations().length;
  @let totalCount = totalParticipations();
  @if (project()) {
    <div class="flex flex-col gap-5">
      <div class="flex flex-col sm:flex-row flex-wrap items-start sm:items-center gap-3 pb-4 border-b border-gray-100">
        <input
          #csvFileInput
          [id]="'participants-csv-input'"
          type="file"
          accept=".csv"
          class="sr-only"
          (change)="onCsvFileSelected($event)"
          [disabled]="projectsStore.isImportingCsv()" />
        <app-ui-button
          type="button"
          variant="outlined"
          size="small"
          [loading]="projectsStore.isImportingCsv()"
          [disabled]="projectsStore.isImportingCsv()"
          (clicked)="triggerCsvFileSelect()">
          <span class="flex items-center gap-2">
            <i-lucide [name]="icons.Upload" class="size-4 shrink-0" />
            @if (selectedCsvFile()) {
              Changer le fichier
            } @else {
              Choisir un fichier CSV
            }
          </span>
        </app-ui-button>
        @if (selectedCsvFile()) {
          <span class="text-gray-500 truncate font-medium text-sm" [title]="selectedCsvFile()?.name">
            {{ selectedCsvFile()?.name }}
          </span>
          <div class="flex flex-wrap gap-2">
            <app-ui-button
              type="button"
              variant="primary"
              size="small"
              [disabled]="projectsStore.isImportingCsv()"
              [loading]="projectsStore.isImportingCsv()"
              (clicked)="importCsv()">
              Importer
            </app-ui-button>
            <app-ui-button type="button" variant="outlined" size="small" (clicked)="clearCsvSelection()">
              Annuler
            </app-ui-button>
          </div>
        }
      </div>
      @if (totalCount > 0) {
        <div class="flex flex-col sm:flex-row gap-3 mb-4 w-full">
          <div class="flex-1 max-w-xs">
            <app-ui-select
              id="phase-filter-select"
              [options]="phaseFilterOptions()"
              [ngModel]="selectedPhase() ?? ''"
              (ngModelChange)="selectPhase($event || null)"
              placeholder="Sélectionner une phase" />
          </div>
          <div class="flex-1">
            <div class="search-input-wrapper w-full">
              <div class="search-input-group">
                <div class="search-input-icon">
                  <i-lucide [name]="icons.Search" class="search-input-icon-svg" />
                </div>
                <input
                  type="text"
                  id="participants-search-input"
                  [ngModel]="searchQuery()"
                  (ngModelChange)="searchQuery.set($event)"
                  placeholder="Rechercher par nom ou email…"
                  class="search-input"
                  autocomplete="off" />
              </div>
            </div>
          </div>
        </div>
      }
      @if (projectsStore.isLoadingParticipations()) {
        <div class="rounded-lg border border-gray-100 bg-white overflow-hidden">
          <div class="px-4 sm:px-6 py-4 border-b border-gray-100">
            <div class="h-5 w-48 bg-gray-200 rounded animate-pulse"></div>
          </div>
          <div class="ui-table-wrapper overflow-x-auto">
            <table class="ui-table">
              <thead class="ui-table-head">
                <tr class="ui-table-head-row">
                  @for (c of [1, 2, 3, 4, 5, 6]; track c) {
                    <th class="ui-table-header"><div class="h-4 w-20 bg-gray-200 rounded animate-pulse"></div></th>
                  }
                </tr>
              </thead>
              <tbody class="ui-table-body">
                @for (i of [1, 2, 3, 4, 5, 6, 7, 8]; track i) {
                  <tr class="ui-table-row">
                    <td class="ui-table-cell">
                      <div class="size-5 rounded border border-gray-200 bg-gray-100 animate-pulse"></div>
                    </td>
                    <td class="ui-table-cell">
                      <div class="flex items-center gap-3">
                        <div class="size-10 rounded-full bg-gray-200 animate-pulse"></div>
                        <div class="h-4 w-28 bg-gray-200 rounded animate-pulse"></div>
                      </div>
                    </td>
                    <td class="ui-table-cell hidden md:table-cell">
                      <div class="h-4 w-36 bg-gray-100 rounded animate-pulse"></div>
                    </td>
                    <td class="ui-table-cell hidden lg:table-cell">
                      <div class="h-4 w-24 bg-gray-100 rounded animate-pulse"></div>
                    </td>
                    <td class="ui-table-cell hidden xl:table-cell">
                      <div class="flex gap-1.5">
                        <div class="h-5 w-16 bg-gray-100 rounded-full animate-pulse"></div>
                      </div>
                    </td>
                    <td class="ui-table-cell"><div class="size-8 rounded-lg bg-gray-200 animate-pulse"></div></td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      }
      @if (!projectsStore.isLoadingParticipations() && totalFiltered === 0) {
        <div class="flex flex-col items-center justify-center rounded-lg border border-gray-200 bg-gray-50 py-12 px-4">
          <div class="flex size-12 items-center justify-center rounded-full bg-gray-100 text-gray-400 mb-3">
            <i-lucide [name]="icons.Users" class="size-6" />
          </div>
          <p class="text-center text-gray-700 font-medium text-sm">Aucune participation</p>
          <p class="text-center text-xs text-gray-500 mt-2 max-w-sm">
            @if (currentPhase()) {
              Aucune participation dans cette phase ou aucun résultat pour la recherche.
            } @else {
              Ce projet n'a pas encore de participations.
            }
          </p>
        </div>
      }
      @if (!projectsStore.isLoadingParticipations() && totalFiltered > 0) {
        <div class="rounded-lg border border-gray-100 bg-white overflow-hidden">
          <div
            class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 px-4 sm:px-6 py-4 border-b border-gray-100 bg-gray-50/50">
            <div class="flex items-center gap-4">
              <label class="ui-checkbox-wrapper flex items-center gap-2 cursor-pointer shrink-0">
                <div class="ui-checkbox-container relative">
                  <input
                    type="checkbox"
                    [checked]="isAllFilteredSelected()"
                    (change)="toggleSelectAll()"
                    class="ui-checkbox-input" />
                  @if (isAllFilteredSelected()) {
                    <div class="ui-checkbox-checkmark">
                      <i-lucide [name]="icons.Check" class="size-4 shrink-0" />
                    </div>
                  }
                </div>
                <span class="ui-checkbox-label text-gray-600">
                  <span class="font-semibold text-gray-900 text-sm tabular-nums">({{ selectedCount() }})</span>
                  <span class="text-gray-500"> sélectionné(e)s</span>
                </span>
              </label>
            </div>
            <app-ui-badge
              [variant]="currentPhase() ? 'info' : 'default'"
              [label]="totalFiltered + ' participation(s)'" />
          </div>

          @if (selectedCount() > 0) {
            <div class="flex flex-col gap-4 py-4 px-4 sm:px-6 border-b border-gray-100 bg-gray-50">
              <div class="flex flex-col sm:flex-row sm:items-end gap-3">
                <div class="flex-1 min-w-0">
                  <label for="operation-type-select" class="block text-sm font-medium text-gray-700 mb-2"
                    >Opération</label
                  >
                  <app-ui-select
                    class="block w-full"
                    id="operation-type-select"
                    [options]="operationTypeOptions"
                    [ngModel]="operationType()"
                    (ngModelChange)="operationType.set($event)"
                    placeholder="Sélectionner une opération" />
                </div>

                @if (operationType() === operationMove) {
                  <div class="flex-1 min-w-0">
                    <label for="move-phase-select" class="block text-sm font-medium text-gray-700 mb-2"
                      >Destination</label
                    >
                    <app-ui-select
                      id="move-phase-select"
                      [options]="movePhaseOptions()"
                      [ngModel]="moveTargetPhase()"
                      (ngModelChange)="moveTargetPhase.set($event)"
                      placeholder="Choisir une phase" />
                  </div>
                  <app-ui-button
                    type="button"
                    variant="primary"
                    size="small"
                    [loading]="projectsStore.isManagingParticipations()"
                    [disabled]="!moveTargetPhase() || projectsStore.isManagingParticipations()"
                    (clicked)="moveToPhase()">
                    <span class="flex items-center justify-center gap-2">
                      @if (!projectsStore.isManagingParticipations()) {
                        <i-lucide [name]="icons.CircleArrowRight" class="size-4" />
                      }
                      Déplacer
                    </span>
                  </app-ui-button>
                }

                @if (operationType() === operationRemove) {
                  <div class="flex-1 min-w-0">
                    <label for="remove-phase-select" class="block text-sm font-medium text-gray-700 mb-2">Phase</label>
                    <app-ui-select
                      id="remove-phase-select"
                      [options]="movePhaseOptions()"
                      [ngModel]="removeTargetPhase()"
                      (ngModelChange)="removeTargetPhase.set($event)"
                      placeholder="Choisir une phase" />
                  </div>
                  <app-ui-button
                    type="button"
                    variant="outlined"
                    size="small"
                    [loading]="projectsStore.isManagingParticipations()"
                    [disabled]="!removeTargetPhase() || projectsStore.isManagingParticipations()"
                    (clicked)="removeFromPhase()">
                    <span class="flex items-center justify-center gap-2">
                      @if (!projectsStore.isManagingParticipations()) {
                        <i-lucide [name]="icons.Trash2" class="size-4" />
                      }
                      Retirer
                    </span>
                  </app-ui-button>
                }

                <app-ui-button
                  [size]="'small'"
                  [variant]="'danger'"
                  (clicked)="clearSelection()"
                  [outlined]="true"
                  class="sm:self-end">
                  <i-lucide [name]="icons.X" class="size-4" />
                  Annuler
                </app-ui-button>
              </div>
            </div>
          }
          <div class="ui-table-wrapper overflow-x-auto">
            <table class="ui-table">
              <thead class="ui-table-head hidden md:table-header-group">
                <tr class="ui-table-head-row">
                  <th class="ui-table-header" scope="col">
                    <span class="sr-only">Sélection</span>
                  </th>
                  <th class="ui-table-header" scope="col">Participant</th>
                  <th class="ui-table-header hidden lg:table-cell" scope="col">Email</th>
                  <th class="ui-table-header" scope="col">Phases</th>
                  <th class="ui-table-header" scope="col">
                    <span class="sr-only">Actions</span>
                  </th>
                </tr>
              </thead>
              <tbody class="ui-table-body divide-y divide-gray-100">
                @for (participation of paginatedParticipations(); track getParticipationKey(participation)) {
                  <tr
                    class="ui-table-row transition-colors duration-150 hover:bg-gray-50/50"
                    [class.bg-primary-50/50]="isSelected(participation)">
                    <td class="ui-table-cell w-12">
                      <div class="ui-checkbox-container relative">
                        <input
                          type="checkbox"
                          [checked]="isSelected(participation)"
                          (change)="toggleSelect(getParticipationKey(participation))"
                          (click)="$event.stopPropagation()"
                          class="ui-checkbox-input" />
                        @if (isSelected(participation)) {
                          <div class="ui-checkbox-checkmark">
                            <i-lucide [name]="icons.Check" class="size-4 shrink-0" />
                          </div>
                        }
                      </div>
                    </td>

                    <!-- Mobile Card Layout / Desktop Row Layout -->
                    <td class="ui-table-cell md:align-middle">
                      <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-3">
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                          <app-ui-avatar
                            [shape]="'circle'"
                            [image]="participation.user | apiIMG: 'user'"
                            [label]="participation.user.name"
                            class="size-10 shrink-0" />
                          <div class="min-w-0 flex-1">
                            <p class="font-medium text-gray-900 truncate">{{ participation.user.name }}</p>
                            <p class="text-xs text-gray-500 md:hidden truncate">
                              {{ participation.user.email || '—' }}
                            </p>
                            @if (participation.venture) {
                              <p class="text-xs text-gray-500 md:hidden truncate">{{ participation.venture.name }}</p>
                            }
                          </div>
                        </div>
                      </div>
                    </td>
                    <td class="ui-table-cell hidden lg:table-cell text-sm text-gray-600">
                      @if (participation.user.email) {
                        <span class="truncate block">{{ participation.user.email }}</span>
                      } @else {
                        <span class="text-gray-400">—</span>
                      }
                    </td>
                    <td class="ui-table-cell">
                      @if (participation.phases.length > 0) {
                        <ul class="flex flex-wrap gap-1" role="list">
                          @for (ph of participation.phases.slice(0, 2); track ph.id) {
                            <li>
                              <app-ui-badge [label]="ph.name" size="small" />
                            </li>
                          }
                          @if (participation.phases.length > 2) {
                            <li class="text-xs text-gray-500 font-medium flex items-center">
                              +{{ participation.phases.length - 2 }}
                            </li>
                          }
                        </ul>
                      } @else {
                        <span class="text-gray-400 text-sm">—</span>
                      }
                    </td>

                    <!-- Expand Button -->
                    <td class="ui-table-cell text-right">
                      <button
                        type="button"
                        [class.rotate-180]="isDetailExpanded(participation)"
                        class="inline-flex rounded-lg p-2 text-gray-400 transition-all hover:bg-gray-100 hover:text-gray-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500"
                        [attr.aria-expanded]="isDetailExpanded(participation)"
                        (click)="toggleDetail(participation)">
                        <i-lucide [name]="icons.ChevronDown" class="size-5" />
                      </button>
                    </td>
                  </tr>

                  <!-- Detail Row -->
                  <tr class="md:hidden">
                    <td class="p-0 align-top" colspan="6">
                      <div
                        class="overflow-hidden transition-[max-height] duration-300 ease-out"
                        [style.max-height.px]="isDetailExpanded(participation) ? 520 : 0">
                        @if (isDetailExpanded(participation)) {
                          <app-participation-detail
                            [participation]="participation"
                            [participationId]="getParticipationKey(participation)" />
                        }
                      </div>
                    </td>
                  </tr>
                  <tr class="hidden md:table-row">
                    <td class="p-0 align-top" colspan="6">
                      <div
                        class="overflow-hidden transition-[max-height] duration-300 ease-out"
                        [style.max-height.px]="isDetailExpanded(participation) ? 520 : 0">
                        @if (isDetailExpanded(participation)) {
                          <div class="bg-gray-50/50 border-t border-gray-100">
                            <app-participation-detail
                              [participation]="participation"
                              [participationId]="getParticipationKey(participation)" />
                          </div>
                        }
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
          <!-- Pagination -->
          @if (totalFiltered > pageSize) {
            <div class="border-t border-gray-100 px-4 sm:px-6 py-4 flex justify-center sm:justify-end bg-gray-50/50">
              <app-ui-pagination
                [currentPage]="currentPage()"
                [totalItems]="totalFiltered"
                [itemsPerPage]="pageSize"
                (pageChange)="onPageChange($event)" />
            </div>
          }
        </div>
      }
    </div>
  }
</div>
