<div class="flex flex-col gap-6">
  @let totalFiltered = filteredParticipations().length;
  @let totalCount = totalParticipations();
  @if (project()) {
    <div class="flex flex-col gap-4">
      <div class="flex flex-wrap items-center gap-2">
        <input
          #csvFileInput
          [id]="'participants-csv-input'"
          type="file"
          accept=".csv"
          class="sr-only"
          (change)="onCsvFileSelected($event)"
          [disabled]="projectsStore.isImportingCsv()" />
        <app-ui-button
          type="button"
          variant="outlined"
          size="small"
          [loading]="projectsStore.isImportingCsv()"
          [disabled]="projectsStore.isImportingCsv()"
          (clicked)="triggerCsvFileSelect()">
          <span class="flex items-center gap-2">
            <i-lucide [name]="icons.Upload" class="size-4 shrink-0" />
            @if (selectedCsvFile()) {
              Changer le fichier
            } @else {
              Choisir un fichier CSV
            }
          </span>
        </app-ui-button>
        @if (selectedCsvFile()) {
          <span class="text-gray-600 truncate max-w-48 font-medium text-sm" [title]="selectedCsvFile()?.name">
            {{ selectedCsvFile()?.name }}
          </span>
          <app-ui-button
            type="button"
            variant="primary"
            size="small"
            [disabled]="projectsStore.isImportingCsv()"
            [loading]="projectsStore.isImportingCsv()"
            (clicked)="importCsv()">
            Importer
          </app-ui-button>
          <app-ui-button type="button" variant="outlined" size="small" (clicked)="clearCsvSelection()">
            Annuler
          </app-ui-button>
        }
      </div>
      @if (totalCount > 0) {
        <div class="flex flex-col gap-3">
          <div class="flex flex-wrap gap-3 text-gray-600">
            <button
              type="button"
              (click)="selectPhase(null)"
              class="font-medium text-sm flex items-center bg-opacity-50 gap-2 rounded-lg border border-gray-200 px-4 py-2.5 text-left transition-colors"
              [class.border-primary-200]="!selectedPhase()"
              [class.bg-primary-50]="!selectedPhase()"
              [class.text-primary-800]="!selectedPhase()">
              <i-lucide [name]="icons.Users" class="size-4 shrink-0" />
              Tous
              <span
                class="size-6 flex font-semibold tabular-nums items-center justify-center bg-gray-100/90 rounded-full">
                {{ totalCount }}
              </span>
            </button>

            @for (phase of sortedPhases(); track phase.id) {
              <button
                type="button"
                (click)="selectPhase(phase.id)"
                class="flex text-sm font-medium items-center bg-opacity-50 gap-2 rounded-lg border border-gray-200 px-4 py-2.5 text-left transition-colors"
                [class.border-primary-200]="selectedPhase() === phase.id"
                [class.bg-primary-50]="selectedPhase() === phase.id"
                [class.text-primary-800]="selectedPhase() === phase.id">
                {{ phase.name }}
                <span
                  class="size-6 flex font-semibold tabular-nums items-center justify-center bg-gray-100/90 rounded-full">
                  {{ phaseCounts().get(phase.id) ?? 0 }}
                </span>
              </button>
            }
          </div>
        </div>
        <div class="flex flex-col sm:flex-row sm:items-end gap-4 mb-4 w-full">
          <div class="search-input-wrapper w-full">
            <div class="search-input-group">
              <div class="search-input-icon">
                <i-lucide [name]="icons.Search" class="search-input-icon-svg" />
              </div>
              <label for="participants-search-input" class="sr-only">Rechercher un participant</label>
              <input
                type="text"
                id="participants-search-input"
                [ngModel]="searchQuery()"
                (ngModelChange)="searchQuery.set($event)"
                placeholder="Nom ou email…"
                class="search-input"
                autocomplete="off" />
            </div>
          </div>
        </div>
      }
      @if (projectsStore.isLoadingParticipations()) {
        <div class="rounded-lg border border-gray-200 bg-white shadow-sm overflow-hidden">
          <div class="px-6 py-4 border-b border-gray-200">
            <div class="h-5 w-48 bg-gray-200 rounded animate-pulse"></div>
          </div>
          <div class="ui-table-wrapper overflow-x-auto">
            <table class="ui-table">
              <thead class="ui-table-head">
                <tr class="ui-table-head-row">
                  @for (c of [1, 2, 3, 4, 5, 6]; track c) {
                    <th class="ui-table-header"><div class="h-4 w-20 bg-gray-200 rounded animate-pulse"></div></th>
                  }
                </tr>
              </thead>
              <tbody class="ui-table-body">
                @for (i of [1, 2, 3, 4, 5, 6, 7, 8]; track i) {
                  <tr class="ui-table-row">
                    <td class="ui-table-cell">
                      <div class="size-5 rounded border border-gray-200 bg-gray-100 animate-pulse"></div>
                    </td>
                    <td class="ui-table-cell">
                      <div class="flex items-center gap-3">
                        <div class="size-10 rounded-full bg-gray-200 animate-pulse"></div>
                        <div class="h-4 w-28 bg-gray-200 rounded animate-pulse"></div>
                      </div>
                    </td>
                    <td class="ui-table-cell"><div class="h-4 w-36 bg-gray-100 rounded animate-pulse"></div></td>
                    <td class="ui-table-cell"><div class="h-4 w-24 bg-gray-100 rounded animate-pulse"></div></td>
                    <td class="ui-table-cell">
                      <div class="flex gap-1.5">
                        <div class="h-5 w-16 bg-gray-100 rounded-full animate-pulse"></div>
                        <div class="h-5 w-20 bg-gray-100 rounded-full animate-pulse"></div>
                      </div>
                    </td>
                    <td class="ui-table-cell"><div class="size-8 rounded-lg bg-gray-200 animate-pulse"></div></td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      }
      @if (!projectsStore.isLoadingParticipations() && totalFiltered === 0) {
        <div
          class="flex flex-col items-center justify-center rounded-lg border border-dashed border-gray-300 bg-gray-50/50 py-12 px-4">
          <div class="flex size-14 items-center justify-center rounded-full bg-primary-50 text-primary-600 mb-4">
            <i-lucide [name]="icons.Users" class="size-7" />
          </div>
          <p class="text-center text-gray-600 font-medium">Aucune participation</p>
          <p class="text-center text-sm text-gray-500 mt-1 max-w-sm">
            @if (currentPhase()) {
              Aucune participation dans cette phase ou aucun résultat pour la recherche.
            } @else {
              Ce projet n'a pas encore de participations.
            }
          </p>
        </div>
      }
      @if (!projectsStore.isLoadingParticipations() && totalFiltered > 0) {
        <div class="rounded-lg border border-gray-200 bg-white shadow-sm overflow-hidden">
          <div class="flex flex-wrap items-center justify-between gap-3 px-6 py-4 border-b border-gray-200">
            <div class="flex items-center gap-5 min-w-0">
              <label class="ui-checkbox-wrapper flex items-center gap-2 cursor-pointer shrink-0">
                <div class="ui-checkbox-container relative">
                  <input
                    type="checkbox"
                    [checked]="isAllFilteredSelected()"
                    (change)="toggleSelectAll()"
                    class="ui-checkbox-input" />
                  @if (isAllFilteredSelected()) {
                    <div class="ui-checkbox-checkmark">
                      <i-lucide [name]="icons.Check" class="size-4 shrink-0" />
                    </div>
                  }
                </div>
                <span class="ui-checkbox-label text-gray-600 sr-only sm:not-sr-only">
                  <span class="font-semibold text-gray-900 shrink-0 tabular-nums text-sm">
                    ({{ selectedCount() }})
                  </span>
                  Tout sélectionner
                </span>
              </label>
            </div>
            <app-ui-badge
              [variant]="currentPhase() ? 'info' : 'default'"
              [label]="totalFiltered + ' participation(s)'" />
          </div>
          <div class="flex flex-col gap-4 py-4 px-6 border-b border-gray-200 bg-gray-50/30">
            <div class="flex flex-col sm:flex-row sm:items-end gap-3 flex-wrap">
              <div class="min-w-0 sm:w-56 shrink-0">
                <label for="operation-type-select" class="sr-only">Type d'opération</label>
                <app-ui-select
                  id="operation-type-select"
                  [options]="operationTypeOptions"
                  [ngModel]="operationType()"
                  (ngModelChange)="operationType.set($event)"
                  placeholder="Opération" />
              </div>
              @if (operationType() === operationMove) {
                <div class="min-w-0 sm:w-64 shrink-0">
                  <app-ui-select
                    id="move-phase-select"
                    [options]="movePhaseOptions()"
                    [ngModel]="moveTargetPhase()"
                    (ngModelChange)="moveTargetPhase.set($event)"
                    placeholder="Déplacer vers la phase" />
                </div>
                <app-ui-button
                  type="button"
                  variant="primary"
                  size="small"
                  [loading]="phasesStore.isLoading()"
                  [disabled]="!moveTargetPhase() || phasesStore.isLoading()"
                  (clicked)="moveToPhase()">
                  <span class="flex items-center gap-2">
                    @if (!phasesStore.isLoading()) {
                      <i-lucide [name]="icons.CircleArrowRight" class="size-4 shrink-0" />
                    }
                    Déplacer
                  </span>
                </app-ui-button>
              }
              @if (operationType() === operationRemove) {
                <div class="min-w-0 sm:w-64 shrink-0">
                  <app-ui-select
                    id="remove-phase-select"
                    [options]="movePhaseOptions()"
                    [ngModel]="removeTargetPhase()"
                    (ngModelChange)="removeTargetPhase.set($event)"
                    placeholder="Retirer de la phase" />
                </div>
                <app-ui-button
                  type="button"
                  variant="outlined"
                  size="small"
                  [loading]="phasesStore.isLoading()"
                  [disabled]="!removeTargetPhase() || phasesStore.isLoading()"
                  (clicked)="removeFromPhase()">
                  <span class="flex items-center justify-center gap-2">
                    @if (!phasesStore.isLoading()) {
                      <i-lucide [name]="icons.Trash2" class="size-4 shrink-0" />
                    }
                    Retirer
                  </span>
                </app-ui-button>
              }
              <button
                type="button"
                class="flex items-center justify-center gap-2 rounded-lg px-3 py-2.5 text-sm font-medium text-gray-600 transition-colors hover:bg-gray-100 hover:text-gray-900 border border-gray-200"
                (click)="clearSelection()">
                <i-lucide [name]="icons.X" class="size-4 shrink-0" />
                Annuler
              </button>
            </div>
          </div>
          <div class="px-6 py-4">
            <h3 class="text-base font-semibold text-gray-900 flex items-center gap-2">
              <i-lucide [name]="icons.LayoutList" class="size-4 text-gray-500" />
              Détail des participations
            </h3>
          </div>
          <div class="ui-table-wrapper overflow-x-auto">
            <table class="ui-table">
              <thead class="ui-table-head">
                <tr class="ui-table-head-row">
                  <th class="ui-table-header" scope="col">
                    <span class="sr-only">Sélection</span>
                  </th>
                  <th class="ui-table-header" scope="col">Participant</th>
                  <th class="ui-table-header" scope="col">Email</th>
                  <th class="ui-table-header" scope="col">Projet</th>
                  <th class="ui-table-header" scope="col">Phases</th>
                  <th class="ui-table-header" scope="col">
                    <span class="sr-only">Détails</span>
                  </th>
                </tr>
              </thead>
              <tbody class="ui-table-body">
                @for (participation of paginatedParticipations(); track participationKey(participation)) {
                  <tr
                    class="ui-table-row transition-colors duration-150"
                    [class.bg-primary-100]="isSelected(participation)"
                    [class.bg-primary-50]="isDetailExpanded(participation) && !isSelected(participation)">
                    <td class="ui-table-cell w-12">
                      <div class="ui-checkbox-container relative">
                        <input
                          type="checkbox"
                          [checked]="isSelected(participation)"
                          (change)="toggleSelect(participationKey(participation))"
                          (click)="$event.stopPropagation()"
                          class="ui-checkbox-input" />
                        @if (isSelected(participation)) {
                          <div class="ui-checkbox-checkmark">
                            <i-lucide [name]="icons.Check" class="size-4 shrink-0" />
                          </div>
                        }
                      </div>
                    </td>
                    <td class="ui-table-cell">
                      <div class="flex items-center gap-3">
                        <app-ui-avatar
                          [shape]="'circle'"
                          [image]="participation.user | apiIMG: 'user'"
                          [label]="participation.user.name"
                          class="size-10" />
                        <span class="font-medium text-gray-900">{{ participation.user.name }}</span>
                      </div>
                    </td>
                    <td class="ui-table-cell text-gray-600">
                      @if (participation.user.email) {
                        {{ participation.user.email }}
                      } @else {
                        <span class="text-gray-400">—</span>
                      }
                    </td>
                    <td class="ui-table-cell">
                      @if (participation.venture) {
                        <span class="text-gray-700 truncate block max-w-48">{{ participation.venture.name }}</span>
                      } @else {
                        <span class="text-gray-400">—</span>
                      }
                    </td>
                    <td class="ui-table-cell">
                      @if (participation.phases.length > 0) {
                        <ul class="flex flex-wrap gap-1.5" role="list">
                          @for (ph of participation.phases; track ph.id) {
                            <li>
                              <app-ui-badge [label]="ph.name" size="small" />
                            </li>
                          }
                        </ul>
                      } @else {
                        <span class="text-gray-400">—</span>
                      }
                    </td>
                    <td class="ui-table-cell">
                      <div class="flex items-center gap-2 justify-end">
                        <button
                          type="button"
                          [class.rotate-180]="isDetailExpanded(participation)"
                          class="rounded-lg p-2 text-gray-500 transition-all hover:bg-gray-100 hover:text-gray-900 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2"
                          (click)="toggleDetail(participation)">
                          <i-lucide [name]="icons.ChevronDown" class="size-5 transition-transform duration-200" />
                        </button>
                      </div>
                    </td>
                  </tr>
                  <tr class="bg-gray-50/50">
                    <td class="p-0 align-top" colspan="6">
                      <div
                        class="overflow-hidden transition-[max-height] duration-300 ease-out"
                        [style.max-height.px]="isDetailExpanded(participation) ? 520 : 0">
                        @if (isDetailExpanded(participation)) {
                          <app-participation-detail
                            [participation]="participation"
                            [participationId]="participationKey(participation)" />
                        }
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
          @if (totalFiltered > pageSize) {
            <div class="border-t border-gray-200 px-6 py-3 flex justify-end">
              <app-ui-pagination
                [currentPage]="currentPage()"
                [totalItems]="totalFiltered"
                [itemsPerPage]="pageSize"
                (pageChange)="onPageChange($event)" />
            </div>
          }
        </div>
      }
    </div>
  }
</div>
