<div class="flex flex-col gap-6">
  @let isLoading = phasesStore.isLoading();
  @let sortedPhases = phasesStore.phases();
  <div class="mb-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <app-ui-badge [label]="sortedPhases.length.toString() + ' Phases'" />
    </div>
    @if (!showCreateForm()) {
      <app-ui-button type="button" variant="primary" size="small" (clicked)="onCreateClick()">
        <span class="flex items-center gap-2">
          <i-lucide [name]="icons.Plus" class="size-4" aria-hidden="true" />
          Créer une phase
        </span>
      </app-ui-button>
    }
  </div>
  @if (showCreateForm() || editingPhaseId()) {
    <div class="border border-gray-200 rounded-xl bg-gray-50/50 p-4 md:p-6" aria-labelledby="phase-form-heading">
      <h4 id="phase-form-heading" class="sr-only">
        {{ editingPhaseId() ? 'Modifier la phase' : 'Nouvelle phase' }}
      </h4>
      <form [formGroup]="form" (ngSubmit)="onSubmit()">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
          <app-ui-input
            [required]="true"
            [id]="'phase-name'"
            label="Nom de la phase"
            formControlName="name"
            placeholder="Ex: Phase de sélection" />
          <app-ui-multi-select
            [id]="'phase-mentors'"
            label="Mentors (optionnel)"
            [options]="mentorOptions()"
            formControlName="mentors"
            placeholder="Sélectionner un ou plusieurs mentors" />
          <div class="grid grid-cols-1 gap-4 lg:col-span-2 lg:grid-cols-2">
            <app-ui-datepicker
              [required]="true"
              [id]="'phase-started_at'"
              label="Date de début"
              formControlName="started_at" />
            <app-ui-datepicker
              [required]="true"
              [id]="'phase-ended_at'"
              label="Date de fin"
              formControlName="ended_at" />
          </div>
        </div>
        <div class="mb-4">
          <app-ui-textarea
            [required]="true"
            [id]="'phase-description'"
            label="Description"
            formControlName="description"
            [rows]="4"
            placeholder="Décrivez les objectifs et le déroulement de cette phase..." />
        </div>
        <div class="mb-4 border border-gray-200 rounded-xl p-4 bg-white">
          <div class="flex items-center justify-between gap-2 mb-3">
            <h5 class="text-sm font-semibold text-gray-700">Livrables (optionnel)</h5>
            <app-ui-button type="button" size="small" variant="primary" [outlined]="true" (clicked)="addDeliverable()">
              <span class="flex items-center gap-2">
                <i-lucide [name]="icons.Plus" class="size-4" aria-hidden="true" />
                Ajouter un livrable
              </span>
            </app-ui-button>
          </div>
          <div formArrayName="deliverables" class="space-y-3">
            @for (deliverable of deliverables.controls; track $index) {
              <div class="border border-gray-200 rounded-lg p-3 bg-gray-50/60" [formGroupName]="$index">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                  <app-ui-input
                    [required]="true"
                    [id]="'phase-deliverable-title-' + $index"
                    label="Titre du livrable"
                    formControlName="title"
                    placeholder="Ex: Rapport d'évaluation" />
                  <app-ui-textarea
                    [id]="'phase-deliverable-description-' + $index"
                    label="Description (optionnelle)"
                    formControlName="description"
                    [rows]="2"
                    placeholder="Précisions sur ce livrable" />
                </div>
                <div class="mt-3 flex justify-end">
                  <app-ui-button
                    type="button"
                    size="small"
                    variant="danger"
                    [outlined]="true"
                    (clicked)="removeDeliverable($index)">
                    Supprimer
                  </app-ui-button>
                </div>
              </div>
            }
          </div>
        </div>
        <div class="flex flex-wrap gap-2 justify-end border-t border-gray-200 pt-4">
          <app-ui-button type="button" [outlined]="true" variant="secondary" size="small" (clicked)="onCancelForm()">
            Annuler
          </app-ui-button>
          <app-ui-button
            (clicked)="editingPhaseId() ? onUpdate() : onSubmit()"
            variant="primary"
            size="small"
            [loading]="isLoading"
            [disabled]="isLoading || form.invalid">
            {{ editingPhaseId() ? 'Enregistrer' : 'Créer la phase' }}
          </app-ui-button>
        </div>
      </form>
    </div>
  }
  @if (isLoading) {
    <ol class="relative space-y-0 border-l-2 border-gray-200 pl-6 md:pl-8">
      @for (i of [1, 2, 3]; track i) {
        <li class="relative pb-8 last:pb-0" role="listitem">
          <span
            class="absolute -left-[1.45rem] top-2 flex size-4 items-center justify-center rounded-full bg-gray-200 ring-4 ring-white animate-pulse"></span>
          <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
            <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
              <div class="min-w-0 flex-1 space-y-2">
                <div class="h-5 w-48 max-w-full bg-gray-200 rounded animate-pulse"></div>
                <div class="flex items-center gap-1">
                  <div class="size-4 bg-gray-100 rounded animate-pulse"></div>
                  <div class="h-4 w-40 bg-gray-100 rounded animate-pulse"></div>
                </div>
                <div class="mt-2 space-y-1">
                  <div class="h-3 w-full bg-gray-100 rounded animate-pulse"></div>
                  <div class="h-3 w-4/5 bg-gray-100 rounded animate-pulse"></div>
                </div>
              </div>
              <div class="flex items-center gap-2 shrink-0">
                <div class="h-9 w-24 bg-gray-100 rounded-lg animate-pulse"></div>
                <div class="h-9 w-24 bg-gray-100 rounded-lg animate-pulse"></div>
              </div>
            </div>
          </div>
        </li>
      }
    </ol>
  }
  @if (sortedPhases.length > 0 && !isLoading) {
    <ol class="relative space-y-0 border-l-2 border-gray-200 pl-6 md:pl-8" role="list" aria-label="Phases du projet">
      @for (phase of sortedPhases; track phase.id) {
        <li class="relative pb-8 last:pb-0" role="listitem">
          <span
            class="absolute -left-[1.45rem] top-2 flex size-4 items-center justify-center rounded-full bg-primary-500 ring-4 ring-white"></span>
          <div
            [class.ring-2]="isEditing(phase)"
            [class.ring-primary-300]="isEditing(phase)"
            class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm transition-shadow hover:shadow-md">
            <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
              <div class="min-w-0 flex-1">
                <h4 class="font-semibold text-gray-900">{{ phase.name }}</h4>
                <div class="mt-1 flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-gray-500">
                  <span class="flex items-center gap-1">
                    <i-lucide [name]="icons.Calendar" class="size-4" aria-hidden="true" />
                    {{ phase.started_at | date: 'dd MMM yyyy' }} - {{ phase.ended_at | date: 'dd MMM yyyy' }}
                  </span>
                </div>
                @if (phase.description) {
                  <p class="mt-2 text-sm text-gray-600 line-clamp-2">{{ phase.description }}</p>
                }
                @if (mentorNamesForPhase(phase).length > 0) {
                  <div class="mt-3 flex flex-wrap gap-2">
                    @for (mentorName of mentorNamesForPhase(phase); track mentorName) {
                      <span
                        class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-1 text-xs font-medium text-gray-700">
                        {{ mentorName }}
                      </span>
                    }
                  </div>
                }
                @if (phase.deliverables.length > 0) {
                  <div class="mt-3 flex flex-wrap gap-2">
                    @for (deliverable of phase.deliverables; track deliverable.id) {
                      <span
                        class="inline-flex items-center rounded-full bg-primary-50 px-2.5 py-1 text-xs font-medium text-primary-700">
                        {{ deliverable.title }}
                      </span>
                    }
                  </div>
                }
              </div>
              <div class="flex items-center gap-2 shrink-0">
                <app-ui-button
                  type="button"
                  size="small"
                  variant="primary"
                  [outlined]="true"
                  (clicked)="onEdit(phase)"
                  [attr.aria-label]="'Modifier la phase ' + phase.name">
                  <i-lucide [name]="icons.Pencil" class="size-4" aria-hidden="true" />
                  Modifier
                </app-ui-button>
                <app-ui-button
                  type="button"
                  size="small"
                  variant="danger"
                  (clicked)="onDelete(phase)"
                  [attr.aria-label]="'Supprimer la phase ' + phase.name">
                  <i-lucide [name]="icons.Trash2" class="size-4" aria-hidden="true" />
                  Supprimer
                </app-ui-button>
              </div>
            </div>
          </div>
        </li>
      }
    </ol>
  }
  @if (sortedPhases.length === 0 && !showCreateForm() && !isLoading) {
    <div
      class="flex flex-col items-center justify-center rounded-xl border border-dashed border-gray-300 bg-gray-50/50 py-12 px-4"
      role="status">
      <div class="flex size-14 items-center justify-center rounded-full bg-primary-50 text-primary-600 mb-4">
        <i-lucide [name]="icons.FileText" class="size-7" aria-hidden="true" />
      </div>
      <p class="text-center text-gray-600 font-medium">Aucune phase pour le moment</p>
      <p class="text-center text-sm text-gray-500 mt-1 max-w-sm">
        Créez une phase pour structurer les étapes de ce projet.
      </p>
      <app-ui-button type="button" variant="primary" size="small" class="mt-4" (clicked)="onCreateClick()">
        <span class="flex items-center gap-2">
          <i-lucide [name]="icons.Plus" class="size-4" aria-hidden="true" />
          Créer une phase
        </span>
      </app-ui-button>
    </div>
  }
  <app-ui-confirm-dialog />
</div>
