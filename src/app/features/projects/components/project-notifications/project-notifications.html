<div class="project-notifications min-w-0 space-y-4 sm:space-y-6">
  <!-- Filters Header -->
  <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
    <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
      <div class="w-full sm:w-52">
        <app-ui-select
          [id]="'notification-phase-filter'"
          [options]="phaseFilterOptions()"
          [ngModel]="filterPhaseId()"
          (ngModelChange)="onFilterPhaseChange($event)"
          placeholder="Toutes les phases" />
      </div>
      <div class="w-full sm:w-40">
        <app-ui-select
          [id]="'notification-status-filter'"
          [options]="statusFilterOptions"
          [ngModel]="filterStatus()"
          (ngModelChange)="onFilterStatusChange($event)"
          placeholder="Tous" />
      </div>
    </div>
    <app-ui-button variant="primary" (clicked)="onComposeNew()" class="w-full sm:w-auto">
      <i-lucide [name]="icons.Plus" class="size-5" />
      <span class="hidden sm:inline">Nouveau</span>
    </app-ui-button>
  </div>

  <!-- Main Layout: Sidebar + Content -->
  <div class="grid min-h-0 grid-cols-1 gap-4 sm:gap-5 lg:grid-cols-[minmax(0,320px)_1fr] lg:items-start">
    <!-- Sidebar: List -->
    <div class="flex flex-col overflow-hidden rounded-lg border border-gray-100 bg-white">
      <!-- Header -->
      <div class="border-b border-gray-100 px-4 py-3">
        <div class="flex items-center justify-between gap-3">
          <h2 class="text-sm font-semibold text-gray-900">Historique</h2>
          <span
            class="inline-flex items-center justify-center rounded-full bg-gray-100 px-2 py-1 text-xs font-medium text-gray-600 min-w-6">
            {{ notificationsStore.total() }}
          </span>
        </div>
      </div>

      <!-- List Content -->
      <div class="min-h-0 flex-1 overflow-y-auto px-3 py-3">
        @if (notificationsStore.list().length === 0) {
          <div
            class="flex flex-col items-center justify-center rounded-lg border border-dashed border-gray-200 bg-gray-50 px-4 py-8 text-center">
            <i-lucide [name]="icons.Inbox" class="mb-2 size-8 text-gray-300" aria-hidden="true" />
            <p class="font-medium text-gray-600">Aucune notification</p>
            <p class="mt-1 text-xs text-gray-500">Créez-en une pour commencer</p>
          </div>
        } @else {
          <ul class="space-y-2">
            @for (notification of notificationsStore.list(); track notification.id) {
              <li>
                <button
                  type="button"
                  (click)="onSelectNotification(notification)"
                  class="group w-full rounded-lg border px-3 py-2.5 text-left transition-all duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500"
                  [class.border-primary-200]="isActive(notification)"
                  [class.bg-primary-50]="isActive(notification)"
                  [class.border-gray-200]="!isActive(notification)"
                  [class.bg-white]="!isActive(notification)"
                  [class.hover:border-gray-300]="!isActive(notification)"
                  [class.hover:bg-gray-50]="!isActive(notification)">
                  <div class="flex items-start justify-between gap-2">
                    <h3 class="min-w-0 flex-1 truncate text-base font-semibold text-gray-900">
                      {{ notification.title }}
                    </h3>
                    <span
                      class="shrink-0 rounded-full px-1.5 py-0.5 text-[10px] font-medium"
                      [class.bg-emerald-100]="notification.status === 'sent'"
                      [class.text-emerald-700]="notification.status === 'sent'"
                      [class.bg-amber-100]="notification.status === 'draft'"
                      [class.text-amber-700]="notification.status === 'draft'">
                      {{ notification.status === 'sent' ? 'Envoyée' : 'Brouillon' }}
                    </span>
                  </div>
                  <p class="mt-1 line-clamp-1 text-xs text-gray-600" [innerHTML]="bodySafe(notification)"></p>
                  <div class="mt-2 flex flex-wrap items-center gap-x-1.5 gap-y-1 text-xs text-gray-400">
                    <span class="truncate">{{ phaseLabel(notification) }}</span>
                    <span class="size-0.5 rounded-full bg-gray-300"></span>
                    <span>{{ notification.created_at | date: 'short' }}</span>
                  </div>
                </button>
              </li>
            }
          </ul>
        }
      </div>

      <!-- Pagination -->
      @if (notificationsStore.list().length > 0) {
        <div class="border-t border-gray-100 px-3 py-2">
          <app-ui-pagination
            [currentPage]="currentPage()"
            [totalItems]="notificationsStore.total()"
            [itemsPerPage]="itemsPerPage"
            (pageChange)="onPageChange($event)" />
        </div>
      }
    </div>

    <!-- Main: View/Compose -->
    <div
      class="flex min-h-[400px] lg:min-h-0 min-w-0 flex-col overflow-hidden rounded-lg border border-gray-100 bg-white">
      <!-- View Mode -->
      @if (!isComposing() && activeNotification(); as notification) {
        <div class="flex min-h-0 flex-1 flex-col">
          <!-- Header -->
          <div class="border-b border-gray-100 bg-gray-50 px-4 py-3 sm:px-6 sm:py-4">
            <div class="flex flex-col gap-3">
              <div class="flex items-start justify-between gap-3">
                <h2 class="min-w-0 flex-1 wrap-break-word text-lg font-semibold text-gray-900 sm:text-xl">
                  {{ notification.title }}
                </h2>
              </div>
              <div class="flex flex-wrap items-center gap-2 text-xs text-gray-600">
                <span class="inline-flex items-center bg-white px-2 py-1 rounded-full ring-1 ring-gray-200">
                  {{ phaseLabel(notification) }}
                </span>
                <span>{{ notification.created_at | date: 'medium' }}</span>
                <span
                  class="rounded-full px-2 py-1 text-xs font-medium"
                  [class.bg-emerald-100]="statusBadge() === 'sent'"
                  [class.text-emerald-700]="statusBadge() === 'sent'"
                  [class.bg-amber-100]="statusBadge() === 'draft'"
                  [class.text-amber-700]="statusBadge() === 'draft'">
                  {{ statusBadge() === 'sent' ? 'Envoyée' : 'Brouillon' }}
                </span>
              </div>
              <p class="text-xs text-gray-500">
                De {{ senderName(notification) }}
                @if (senderEmail(notification)) {
                  <span class="text-gray-400"> — {{ senderEmail(notification) }}</span>
                }
              </p>
            </div>
          </div>

          <!-- Content -->
          <div class="min-h-0 flex-1 overflow-y-auto px-4 py-4 space-y-4 sm:px-6">
            <div class="rounded-lg border border-gray-100 bg-white p-4">
              <div
                class="text-sm text-gray-700 leading-relaxed prose prose-sm max-w-none"
                [innerHTML]="bodySafe(notification)"></div>
            </div>
            @if (notification.attachments?.length) {
              <div class="rounded-lg border border-gray-100 bg-gray-50 p-4">
                <p class="text-xs font-semibold text-gray-800 mb-3">
                  Pièces jointes · {{ attachmentSummary(notification) }}
                </p>
                <ul class="space-y-2">
                  @for (att of notification.attachments; track att.id) {
                    <li>
                      <a
                        [href]="attachmentUrl(att.filename)"
                        target="_blank"
                        rel="noopener"
                        class="inline-flex items-center gap-2 rounded-lg bg-white px-3 py-2 text-xs text-primary-700 ring-1 ring-gray-200 transition hover:bg-primary-50">
                        <i-lucide [name]="icons.Paperclip" class="size-3.5 shrink-0" />
                        <span class="truncate">{{ att.filename }}</span>
                      </a>
                    </li>
                  }
                </ul>
              </div>
            }
          </div>

          <!-- Actions -->
          <div
            class="border-t border-gray-100 bg-gray-50 px-4 py-3 flex flex-wrap items-center justify-end gap-2 sm:px-6">
            @if (statusBadge() === 'draft') {
              <app-ui-button
                type="button"
                variant="primary"
                size="small"
                [disabled]="notificationsStore.isSaving()"
                [loading]="listActionLoading() === 'send'"
                (clicked)="resendNotification(notification)">
                <i-lucide [name]="icons.Send" class="size-4" />
                <span class="hidden sm:inline">Envoyer</span>
              </app-ui-button>
            }
            @if (statusBadge() === 'sent') {
              <app-ui-button
                type="button"
                variant="primary"
                size="small"
                [disabled]="notificationsStore.isSaving()"
                [loading]="listActionLoading() === 'send'"
                (clicked)="resendNotification(notification)">
                <i-lucide [name]="icons.Send" class="size-4" />
                <span class="hidden sm:inline">Renvoyer</span>
              </app-ui-button>
            }
            <app-ui-button type="button" variant="outlined" size="small" (clicked)="onEditNotification()">
              <i-lucide [name]="icons.Pencil" class="size-4" />
              <span class="hidden sm:inline">Modifier</span>
            </app-ui-button>
            <app-ui-button
              type="button"
              variant="outlined"
              size="small"
              class="border-red-200 text-red-600 hover:bg-red-50"
              (clicked)="deleteNotification(notification)">
              <i-lucide [name]="icons.Trash2" class="size-4" />
              <span class="hidden sm:inline">Supprimer</span>
            </app-ui-button>
          </div>
        </div>
      }

      <!-- Compose Mode -->
      @if (isComposing()) {
        <form class="flex min-h-0 flex-1 flex-col" [formGroup]="form">
          <!-- Header -->
          <div class="border-b border-gray-100 bg-gray-50 px-4 py-3 flex items-center justify-between sm:px-6">
            <h2 class="text-sm font-semibold text-gray-900">
              {{ activeNotification() ? 'Modifier' : 'Nouvelle notification' }}
            </h2>
          </div>

          <!-- Form -->
          <div class="min-h-0 flex-1 overflow-y-auto">
            <div class="mx-auto w-full max-w-2xl space-y-5 px-4 py-5 sm:px-6">
              <div class="space-y-2">
                <app-ui-select
                  [id]="'phase_id'"
                  label="Destinataires"
                  [options]="phaseOptions()"
                  formControlName="phase_id"
                  placeholder="Tous les participants" />
              </div>
              @if (form.value.phase_id) {
                <div class="space-y-2 rounded-lg border border-gray-100 bg-gray-50 p-3">
                  <app-ui-checkbox
                    [id]="'notify_mentors'"
                    formControlName="notify_mentors"
                    label="Notifier uniquement les mentors de la phase" />
                </div>
              }
              <div class="space-y-2">
                <app-ui-input
                  [id]="'title'"
                  label="Objet"
                  [required]="true"
                  formControlName="title"
                  placeholder="Ex. Mise à jour importante" />
              </div>
              <div class="space-y-2">
                <app-ui-text-editor
                  [id]="'body'"
                  formControlName="body"
                  [placeholder]="'Rédigez votre message...'"
                  [minHeight]="'180px'"
                  [invalid]="!!(form.get('body')?.invalid && form.get('body')?.touched)" />
              </div>

              <!-- Attachments -->
              <div class="rounded-lg border border-gray-100 bg-gray-50 p-4">
                <div class="mb-3 flex flex-wrap items-center justify-between gap-2">
                  <span class="flex items-center gap-2 text-xs font-semibold text-gray-800">
                    <i-lucide [name]="icons.Paperclip" class="size-4 text-primary-600" />
                    Pièces jointes
                  </span>
                  <input
                    #notificationAttachments
                    id="notification-attachments"
                    type="file"
                    class="sr-only"
                    multiple
                    (change)="onSelectFiles($event)" />
                  <app-ui-button
                    type="button"
                    variant="outlined"
                    size="small"
                    (clicked)="notificationAttachments.click()">
                    Ajouter
                  </app-ui-button>
                </div>
                @if (attachments().length > 0) {
                  <ul class="space-y-2 mb-2">
                    @for (item of attachments(); track item.id) {
                      <li
                        class="flex items-center justify-between rounded-lg border border-gray-200 bg-white px-3 py-2">
                        <div class="min-w-0 flex-1">
                          <p class="truncate text-xs font-medium text-gray-800">{{ item.file.name }}</p>
                          <p class="text-xs text-gray-500">{{ formatBytes(item.file.size) }}</p>
                        </div>
                        <button
                          type="button"
                          class="rounded-lg p-1 text-gray-400 hover:bg-red-50 hover:text-red-600 transition"
                          (click)="removeAttachment(item.id)">
                          <i-lucide [name]="icons.X" class="size-4" />
                        </button>
                      </li>
                    }
                  </ul>
                  <button
                    type="button"
                    class="text-xs text-gray-500 hover:text-gray-700 transition"
                    (click)="clearAttachments()">
                    Effacer
                  </button>
                }
                @if (activeNotification()?.attachments?.length) {
                  <div class="mt-3 border-t border-gray-200 pt-3">
                    <p class="text-xs font-medium text-gray-600 mb-2">Existants</p>
                    <ul class="space-y-1">
                      @for (existing of activeNotification()?.attachments ?? []; track existing.id) {
                        <li>
                          <a
                            [href]="attachmentUrl(existing.filename)"
                            target="_blank"
                            rel="noopener"
                            class="text-xs text-primary-600 hover:underline">
                            {{ existing.filename }}
                          </a>
                        </li>
                      }
                    </ul>
                  </div>
                }
              </div>

              @if (notificationsStore.error()) {
                <div
                  class="flex items-start gap-3 rounded-lg border border-red-200 bg-red-50 p-3 text-xs text-red-700"
                  role="alert">
                  <i-lucide [name]="icons.CircleAlert" class="mt-0.5 size-4 shrink-0" />
                  <div>
                    <span class="font-semibold">Erreur</span>
                    {{ notificationsStore.error() }}
                  </div>
                </div>
              }
            </div>
          </div>

          <!-- Footer -->
          <div
            class="border-t border-gray-100 bg-gray-50 px-4 py-3 flex flex-wrap items-center justify-between gap-2 sm:px-6">
            <app-ui-button type="button" variant="secondary" (clicked)="onCancelCompose()"> Annuler </app-ui-button>
            <div class="flex flex-wrap items-center gap-2">
              <app-ui-button
                type="button"
                variant="outlined"
                [disabled]="form.invalid || notificationsStore.isSaving()"
                [loading]="composeActionLoading() === 'save'"
                (clicked)="onSaveDraft()">
                Enregistrer
              </app-ui-button>
              @if (activeNotification()) {
                <app-ui-button
                  type="button"
                  variant="primary"
                  [disabled]="form.invalid || notificationsStore.isSaving()"
                  [loading]="composeActionLoading() === 'send'"
                  (clicked)="onSend()">
                  @if (composeActionLoading() !== 'send') {
                    <i-lucide [name]="icons.Send" class="size-4" />
                  }
                  <span class="hidden sm:inline">Envoyer</span>
                </app-ui-button>
              }
            </div>
          </div>
        </form>
      }
    </div>
  </div>

  <app-ui-confirm-dialog />
</div>
