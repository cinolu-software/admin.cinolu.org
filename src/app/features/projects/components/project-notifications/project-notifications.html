<div class="rounded-2xl border-gray-200 bg-white/80 my-6">
  <div class="flex flex-col gap-2 mb-6">
    <div class="flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="size-10 rounded-xl bg-primary-50 text-primary-700 flex items-center justify-center">
          <i-lucide [name]="icons.Bell" class="size-5" />
        </div>
        <div>
          <h3 class="text-lg font-semibold text-gray-900">Notifications du projet</h3>
        </div>
      </div>
      <app-ui-button type="button" variant="primary" size="small" (clicked)="onComposeNew()">
        <span class="flex items-center gap-2">
          <i-lucide [name]="icons.Plus" class="size-4" />
          Nouvelle notification
        </span>
      </app-ui-button>
    </div>
  </div>
  <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
    <div class="xl:col-span-1 flex flex-col gap-4">
      <div class="rounded-xl border border-gray-200 bg-gray-50/70 p-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2 text-sm font-semibold text-gray-700">
            <i-lucide [name]="icons.Inbox" class="size-4" />
            Historique d'envoi
          </div>
          <span class="text-xs text-gray-500">{{ notificationsStore.total() }} message(s)</span>
        </div>
      </div>
      <div class="rounded-xl border border-gray-200 bg-white p-4">
        <div class="flex flex-col gap-3">
          <app-ui-select
            [id]="'notification-phase-filter'"
            label="Phase"
            [options]="phaseFilterOptions()"
            [ngModel]="filterPhaseId()"
            (ngModelChange)="onFilterPhaseChange($event)"
            placeholder="Toutes les phases" />
          <app-ui-select
            [id]="'notification-status-filter'"
            label="Statut"
            [options]="statusFilterOptions"
            [ngModel]="filterStatus()"
            (ngModelChange)="onFilterStatusChange($event)"
            placeholder="Tous" />
        </div>
      </div>
      @if (notificationsStore.list().length === 0) {
        <div
          class="flex flex-col items-center justify-center rounded-xl border border-dashed border-gray-200 bg-white py-10 px-4 text-center">
          <div class="size-12 rounded-full bg-primary-50 text-primary-700 flex items-center justify-center mb-3">
            <i-lucide [name]="icons.Bell" class="size-6" />
          </div>
          <p class="text-sm font-medium text-gray-700">Aucune notification envoyée</p>
          <p class="text-xs text-gray-500 mt-1">Envoyez votre première notification pour démarrer.</p>
        </div>
      }
      @for (notification of notificationsStore.list(); track notification.id) {
        <div
          role="button"
          tabindex="0"
          (click)="onSelectNotification(notification)"
          class="text-left rounded-xl border transition p-4 w-full cursor-pointer"
          [ngClass]="{
            'border-primary-300 bg-primary-50/60 shadow-sm': isActive(notification),
            'border-gray-200 bg-white hover:border-gray-300 hover:bg-gray-50': !isActive(notification)
          }">
          <div class="flex items-start justify-between gap-2">
            <div>
              <p class="text-sm font-semibold text-gray-900 line-clamp-1">{{ notification.title }}</p>
              <p class="text-xs text-gray-500 mt-1 line-clamp-2">{{ notification.body }}</p>
              <p class="text-[11px] text-gray-400 mt-2">
                De: {{ senderName(notification) }}
                @if (senderEmail(notification)) {
                  <span class="text-gray-400">• {{ senderEmail(notification) }}</span>
                }
              </p>
            </div>
            <button
              type="button"
              class="p-1 text-gray-400 hover:text-red-500"
              (click)="$event.stopPropagation(); deleteNotification(notification)">
              <i-lucide [name]="icons.Trash2" class="size-4" />
            </button>
          </div>
          <div class="flex flex-wrap gap-2 items-center mt-3">
            <span class="text-xs font-medium text-primary-700 bg-primary-100 px-2 py-1 rounded-full">
              {{ phaseLabel(notification) }}
            </span>
            <span class="text-xs text-gray-500">{{ attachmentSummary(notification) }}</span>
          </div>
          <div class="text-[11px] text-gray-400 mt-2">{{ notification.created_at | date: 'medium' }}</div>
        </div>
      }
      <div class="mt-4">
        <app-ui-pagination
          [currentPage]="currentPage()"
          [totalItems]="notificationsStore.total()"
          [itemsPerPage]="itemsPerPage"
          (pageChange)="onPageChange($event)" />
      </div>
    </div>

    <div class="xl:col-span-2">
      <form class="rounded-2xl border border-gray-200 bg-white p-5 md:p-6" [formGroup]="form">
        <!-- Stepper: 1. Create, 2. Update / attachments, 3. Send -->
        <nav class="flex items-center gap-2 mb-6">
          <ol class="flex items-center gap-2 flex-wrap" role="list">
            <li class="flex items-center gap-2">
              <span
                class="flex size-8 items-center justify-center rounded-full text-sm font-semibold"
                [class.bg-primary-600]="currentStep() === 1"
                [class.text-white]="currentStep() === 1"
                [class.bg-primary-100]="currentStep() > 1"
                [class.text-primary-700]="currentStep() > 1"
                aria-current="step">
                @if (currentStep() > 1) {
                  <i-lucide [name]="icons.Check" class="size-4" />
                } @else {
                  1
                }
              </span>
              <span class="text-sm font-medium" [class.text-gray-500]="currentStep() > 1">Rédiger la notification</span>
            </li>
            <li class="flex items-center gap-2 text-gray-300" aria-hidden="true">
              <i-lucide [name]="icons.ChevronRight" class="size-4" />
            </li>
            <li class="flex items-center gap-2">
              <span
                class="flex size-8 items-center justify-center rounded-full text-sm font-semibold"
                [class.bg-primary-600]="currentStep() === 2"
                [class.text-white]="currentStep() === 2"
                [class.bg-gray-100]="currentStep() < 2"
                [class.text-gray-400]="currentStep() < 2">
                2
              </span>
              <span class="text-sm font-medium" [class.text-gray-500]="currentStep() !== 2"
                >Pièces jointes (facultatif)</span
              >
            </li>
            <li class="flex items-center gap-2 text-gray-300" aria-hidden="true">
              <i-lucide [name]="icons.ChevronRight" class="size-4" />
            </li>
            <li class="flex items-center gap-2">
              <span
                class="flex size-8 items-center justify-center rounded-full text-sm font-semibold"
                [class.bg-primary-600]="currentStep() === 3"
                [class.text-white]="currentStep() === 3"
                [class.bg-primary-100]="currentStep() > 3"
                [class.text-primary-700]="currentStep() > 3"
                [class.bg-gray-100]="currentStep() < 3"
                [class.text-gray-400]="currentStep() < 3"
                aria-current="step">
                @if (currentStep() > 3) {
                  <i-lucide [name]="icons.Check" class="size-4" />
                } @else {
                  3
                }
              </span>
              <span class="text-sm font-medium" [class.text-gray-500]="currentStep() !== 3">Envoyer</span>
            </li>
          </ol>
        </nav>

        @if (currentStep() === 1) {
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <app-ui-select
              [id]="'phase_id'"
              label="Destinataires"
              [options]="phaseOptions()"
              formControlName="phase_id"
              placeholder="Tous les participants" />
          </div>
          <div class="mb-4">
            <app-ui-input
              [id]="'title'"
              label="Objet"
              [required]="true"
              formControlName="title"
              placeholder="Ex: Mise à jour importante" />
          </div>
          <app-ui-textarea
            [id]="'body'"
            label="Message"
            [required]="true"
            [rows]="8"
            formControlName="body"
            placeholder="Rédigez votre message comme un email ...">
          </app-ui-textarea>
        }

        @if (currentStep() === 2) {
          <div class="mt-4 rounded-xl border border-dashed border-gray-200 bg-gray-50/70 p-4">
            <div class="flex items-center justify-between gap-3">
              <div class="flex items-center gap-2 text-sm font-semibold text-gray-700">
                <i-lucide [name]="icons.Paperclip" class="size-4" />
                Pièces jointes
              </div>
              <input
                #notificationAttachments
                id="notification-attachments"
                type="file"
                class="sr-only"
                multiple
                (change)="onSelectFiles($event)" />
              <app-ui-button type="button" variant="outlined" size="small" (clicked)="notificationAttachments.click()">
                Ajouter des fichiers
              </app-ui-button>
            </div>
            @if (attachments().length === 0) {
              <p class="text-xs text-gray-500 mt-2">Formats libres. Cliquez sur Suivant pour passer.</p>
            } @else {
              <div class="mt-3 flex flex-col gap-2">
                @for (item of attachments(); track item.id) {
                  <div class="flex items-center justify-between rounded-lg border border-gray-200 bg-white px-3 py-2">
                    <div class="flex items-center gap-3">
                      <i-lucide [name]="icons.Paperclip" class="size-4 text-primary-700" />
                      <div>
                        <p class="text-sm font-medium text-gray-800">{{ item.file.name }}</p>
                        <p class="text-xs text-gray-500">{{ formatBytes(item.file.size) }}</p>
                      </div>
                    </div>
                    <button type="button" class="text-gray-400 hover:text-red-500" (click)="removeAttachment(item.id)">
                      <i-lucide [name]="icons.X" class="size-4" />
                    </button>
                  </div>
                }
                <button type="button" class="text-xs text-gray-500 hover:text-gray-700" (click)="clearAttachments()">
                  Effacer la sélection
                </button>
              </div>
            }
            @if (activeNotification()?.attachments?.length) {
              <div class="mt-4 border-t border-gray-200 pt-4">
                <p class="text-xs font-semibold text-gray-600">Déjà enregistrées</p>
                <div class="mt-2 flex flex-col gap-2">
                  @for (existing of activeNotification()?.attachments ?? []; track existing.id) {
                    <a
                      class="text-sm text-primary-700 hover:underline"
                      [href]="attachmentUrl(existing.filename)"
                      target="_blank"
                      rel="noopener">
                      {{ existing.filename }}
                    </a>
                  }
                </div>
              </div>
            }
          </div>
        }

        @if (currentStep() === 3) {
          <div class="rounded-xl border border-gray-200 bg-gray-50/70 p-4 space-y-3">
            <p class="text-sm font-medium text-gray-900">{{ activeNotification()?.title }}</p>
            <p class="text-sm text-gray-600 whitespace-pre-wrap">{{ activeNotification()?.body }}</p>
            <p class="text-xs text-gray-500">Destinataires : {{ phaseLabelForSummary() }}</p>
            @if (attachments().length > 0 || activeNotification()?.attachments?.length) {
              <p class="text-xs text-gray-500">
                {{ attachments().length || activeNotification()?.attachments?.length || 0 }} pièce(s) jointe(s)
              </p>
            }
          </div>
        }

        @if (notificationsStore.error()) {
          <div class="mt-4 rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700" role="alert">
            <span class="font-medium">Erreur</span>
            {{ notificationsStore.error() }}
          </div>
        }

        <!-- One action per step -->
        <div class="mt-6 flex flex-wrap items-center justify-between gap-3 border-t border-gray-200 pt-5">
          <div class="flex items-center gap-2">
            @if (currentStep() > 1) {
              <app-ui-button type="button" variant="secondary" size="small" (clicked)="goBack()">
                Retour
              </app-ui-button>
            }
          </div>
          <div class="flex gap-2">
            @if (currentStep() === 1) {
              <app-ui-button
                type="button"
                variant="primary"
                size="small"
                [disabled]="form.invalid || notificationsStore.isSaving()"
                [loading]="notificationsStore.isSaving()"
                (clicked)="onStep1Create()">
                <span class="flex items-center gap-2">
                  <i-lucide [name]="icons.Plus" class="size-4" />
                  Créer
                </span>
              </app-ui-button>
            } @else if (currentStep() === 2) {
              <app-ui-button
                type="button"
                variant="primary"
                size="small"
                [disabled]="notificationsStore.isUploading()"
                [loading]="notificationsStore.isUploading()"
                (clicked)="onStep2Next()">
                <span class="flex items-center gap-2">
                  @if (attachments().length > 0) {
                    <i-lucide [name]="icons.Paperclip" class="size-4" />
                    Ajouter les pièces jointes
                  } @else {
                    <i-lucide [name]="icons.ChevronRight" class="size-4" />
                    Passer
                  }
                </span>
              </app-ui-button>
            } @else {
              <app-ui-button
                type="button"
                variant="primary"
                size="small"
                [disabled]="notificationsStore.isSaving()"
                [loading]="notificationsStore.isSaving()"
                (clicked)="onStep3Send()">
                <span class="flex items-center gap-2">
                  <i-lucide [name]="icons.Send" class="size-4" />
                  Envoyer
                </span>
              </app-ui-button>
            }
          </div>
        </div>
      </form>
    </div>
  </div>
  <app-ui-confirm-dialog />
</div>
